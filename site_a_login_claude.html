<!DOCTYPE html>
<html>
<head>
  <title>Site A - Login</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
</head>
<body>
  <h1>ğŸ” Site A - Login</h1>
  <button id="loginButton">Entrar anonimamente</button>
  <button id="logoutButton" style="display:none;">Sair</button>
  <p id="status">Status: Carregando...</p>
  <div id="logs" style="margin-top: 20px; padding: 10px; background: #f0f0f0; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto;"></div>

  <script>
    const logDiv = document.getElementById('logs');
    
    function addLog(message) {
      const timestamp = new Date().toLocaleTimeString();
      const logMessage = `[${timestamp}] ${message}`;
      console.log(logMessage);
      logDiv.innerHTML += logMessage + '<br>';
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    addLog("[Site A] ğŸš€ Iniciando Site A...");

    let auth;
    let isReady = false;
    let currentUser = null;

    // Detecta se estÃ¡ em iframe
    const isInIframe = window !== window.parent;
    addLog(`[Site A] ğŸ“± EstÃ¡ em iframe: ${isInIframe}`);

    fetch('https://broken-silence-aaa9.2gabrielekaline.workers.dev')
      .then(response => {
        addLog("[Site A] ğŸ“¡ Resposta da API recebida");
        return response.json();
      })
      .then(firebaseConfig => {
        addLog("[Site A] âš™ï¸ ConfiguraÃ§Ã£o Firebase recebida");
        addLog(`[Site A] ğŸ”‘ Project ID: ${firebaseConfig.projectId}`);
        
        firebase.initializeApp(firebaseConfig);
        auth = firebase.auth();
        addLog("[Site A] ğŸ”¥ Firebase inicializado");

        return firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL);
      })
      .then(() => {
        addLog("[Site A] ğŸ’¾ PersistÃªncia LOCAL configurada");
        
        // Configura listener de mudanÃ§a de estado
        auth.onAuthStateChanged((user) => {
          addLog(`[Site A] ğŸ‘¤ Estado de auth mudou: ${user ? 'LOGADO' : 'DESLOGADO'}`);
          
          currentUser = user;
          updateStatus(user);
          
          if (!isReady) {
            isReady = true;
            addLog("[Site A] âœ… Firebase estÃ¡ pronto para comunicaÃ§Ã£o");
            
            // ForÃ§a sincronizaÃ§Ã£o do estado se estiver em iframe
            if (isInIframe) {
              setTimeout(() => {
                forceSyncAuthState();
                notifySiteB();
              }, 100);
            }
          } else if (isInIframe) {
            // Se jÃ¡ estava pronto, notifica mudanÃ§as de estado
            setTimeout(() => {
              notifySiteB();
            }, 100);
          }
        });
        
        // Registra listener de mensagens
        setupMessageListener();
      })
      .catch(error => {
        addLog(`[Site A] âŒ Erro na inicializaÃ§Ã£o: ${error.message}`);
        console.error("[Site A] Erro completo:", error);
      });

    function forceSyncAuthState() {
      addLog("[Site A] ğŸ”„ ForÃ§ando sincronizaÃ§Ã£o do estado de auth...");
      
      if (!auth) {
        addLog("[Site A] âŒ Auth nÃ£o disponÃ­vel para sincronizaÃ§Ã£o");
        return;
      }
      
      // ForÃ§a recarregamento do token atual se existir
      const user = auth.currentUser;
      if (user) {
        addLog(`[Site A] ğŸ”‘ ForÃ§ando reload do token para usuÃ¡rio: ${user.uid}`);
        
        user.getIdToken(true)
          .then((token) => {
            addLog("[Site A] âœ… Token recarregado com sucesso");
            addLog(`[Site A] ğŸ« Token length: ${token.length} chars`);
          })
          .catch((error) => {
            addLog(`[Site A] âŒ Erro ao recarregar token: ${error.message}`);
          });
      } else {
        addLog("[Site A] ğŸ” Tentando recuperar estado de auth persistido...");
        
        // Tenta detectar se hÃ¡ uma sessÃ£o ativa mas nÃ£o carregada
        auth.getRedirectResult()
          .then((result) => {
            if (result.user) {
              addLog(`[Site A] ğŸ‰ UsuÃ¡rio recuperado do redirect: ${result.user.uid}`);
            } else {
              addLog("[Site A] ğŸ“­ Nenhum usuÃ¡rio no redirect result");
            }
          })
          .catch((error) => {
            addLog(`[Site A] âš ï¸ Erro no redirect result: ${error.message}`);
          });
      }
    }

    function notifySiteB() {
      addLog("[Site A] ğŸ“¤ Enviando siteAReady para Site B");
      try {
        window.parent.postMessage({ 
          type: 'siteAReady',
          timestamp: new Date().toISOString(),
          currentUser: currentUser ? { uid: currentUser.uid, isAnonymous: currentUser.isAnonymous } : null
        }, '*');
        addLog("[Site A] âœ… Mensagem siteAReady enviada com sucesso");
      } catch (error) {
        addLog(`[Site A] âŒ Erro ao enviar siteAReady: ${error.message}`);
      }
    }

    function setupMessageListener() {
      addLog("[Site A] ğŸ”— Configurando listener de mensagens");
      
      window.addEventListener("message", (event) => {
        addLog(`[Site A] ğŸ“¨ Mensagem recebida de: ${event.origin}`);
        addLog(`[Site A] ğŸ“„ Dados da mensagem: ${JSON.stringify(event.data)}`);

        if (!auth) {
          addLog("[Site A] âš ï¸ Auth nÃ£o disponÃ­vel, ignorando mensagem");
          return;
        }

        if (!isReady) {
          addLog("[Site A] âš ï¸ Firebase nÃ£o estÃ¡ pronto, ignorando mensagem");
          return;
        }

        if (event.data && event.data.type === "checkLogin") {
          addLog("[Site A] ğŸ” SolicitaÃ§Ã£o de verificaÃ§Ã£o de login recebida");
          
          // ForÃ§a sincronizaÃ§Ã£o antes de responder
          forceSyncAuthState();
          
          // Aguarda um momento para sincronizaÃ§Ã£o e entÃ£o responde
          setTimeout(() => {
            const user = auth.currentUser;
            addLog(`[Site A] ğŸ‘¤ UsuÃ¡rio atual apÃ³s sync: ${user ? user.uid : 'null'}`);
            
            const response = {
              type: "loginStatus",
              loggedIn: !!user,
              uid: user?.uid || null,
              isAnonymous: user?.isAnonymous || false,
              timestamp: new Date().toISOString(),
              context: isInIframe ? 'iframe' : 'standalone'
            };
            
            addLog(`[Site A] ğŸ“¤ Enviando resposta: ${JSON.stringify(response)}`);
            
            try {
              event.source.postMessage(response, event.origin);
              addLog("[Site A] âœ… Resposta enviada com sucesso");
            } catch (error) {
              addLog(`[Site A] âŒ Erro ao enviar resposta: ${error.message}`);
            }
          }, 500); // Aguarda 500ms para sincronizaÃ§Ã£o
        } else {
          addLog(`[Site A] â“ Tipo de mensagem desconhecido: ${event.data?.type}`);
        }
      });
      
      addLog("[Site A] âœ… Listener de mensagens configurado");
    }

    // Adiciona botÃ£o para forÃ§ar sincronizaÃ§Ã£o manual
    const syncButton = document.createElement('button');
    syncButton.id = 'syncButton';
    syncButton.textContent = 'ğŸ”„ Sincronizar Estado';
    syncButton.style.marginLeft = '10px';
    document.querySelector('h1').after(syncButton);

    syncButton.addEventListener('click', () => {
      addLog("[Site A] ğŸ”„ SincronizaÃ§Ã£o manual solicitada");
      forceSyncAuthState();
      
      setTimeout(() => {
        const user = auth.currentUser;
        if (user) {
          addLog(`[Site A] âœ… ApÃ³s sincronizaÃ§Ã£o - UsuÃ¡rio: ${user.uid}`);
        } else {
          addLog("[Site A] âŒ ApÃ³s sincronizaÃ§Ã£o - Nenhum usuÃ¡rio");
        }
        updateStatus(user);
      }, 1000);
    });

    // Event listeners dos botÃµes
    document.getElementById("loginButton").addEventListener("click", () => {
      addLog("[Site A] ğŸ” Tentando fazer login anÃ´nimo");
      
      if (!auth) {
        addLog("[Site A] âŒ Firebase ainda nÃ£o carregou");
        alert("Firebase ainda nÃ£o carregou!");
        return;
      }
      
      auth.signInAnonymously()
        .then((userCredential) => {
          const user = userCredential.user;
          addLog(`[Site A] âœ… Login anÃ´nimo realizado com sucesso - UID: ${user.uid}`);
          currentUser = user;
          
          // Notifica Site B imediatamente apÃ³s login (se em iframe)
          if (isInIframe) {
            setTimeout(() => {
              addLog("[Site A] ğŸ“¢ Notificando Site B sobre novo login");
              notifySiteB();
            }, 100);
          }
        })
        .catch(error => {
          addLog(`[Site A] âŒ Erro no login: ${error.message}`);
          console.error("[Site A] Erro completo no login:", error);
        });
    });

    document.getElementById("logoutButton").addEventListener("click", () => {
      addLog("[Site A] ğŸšª Fazendo logout");
      
      auth.signOut()
        .then(() => {
          addLog("[Site A] âœ… Logout realizado com sucesso");
          currentUser = null;
          
          // Notifica Site B sobre logout (se em iframe)
          if (isInIframe) {
            setTimeout(() => {
              addLog("[Site A] ğŸ“¢ Notificando Site B sobre logout");
              notifySiteB();
            }, 100);
          }
        })
        .catch(error => {
          addLog(`[Site A] âŒ Erro no logout: ${error.message}`);
        });
    });

    function updateStatus(user) {
      const statusEl = document.getElementById("status");
      const loginBtn = document.getElementById("loginButton");
      const logoutBtn = document.getElementById("logoutButton");
      
      if (user) {
        addLog(`[Site A] ğŸ‘¤ UsuÃ¡rio logado - UID: ${user.uid} | AnÃ´nimo: ${user.isAnonymous}`);
        statusEl.innerText = `Status: Logado! (${user.uid.substring(0, 8)}...)`;
        statusEl.style.color = "green";
        loginBtn.style.display = "none";
        logoutBtn.style.display = "inline-block";
      } else {
        addLog("[Site A] ğŸš« Nenhum usuÃ¡rio logado");
        statusEl.innerText = "Status: NÃ£o logado";
        statusEl.style.color = "red";
        loginBtn.style.display = "inline-block";
        logoutBtn.style.display = "none";
      }
    }

    // Log quando a pÃ¡gina termina de carregar
    window.addEventListener('load', () => {
      addLog("[Site A] ğŸ“„ PÃ¡gina totalmente carregada");
    });

    // Log de erros gerais
    window.addEventListener('error', (event) => {
      addLog(`[Site A] ğŸ’¥ Erro JavaScript: ${event.message} em ${event.filename}:${event.lineno}`);
    });
  </script>
</body>
</html>
