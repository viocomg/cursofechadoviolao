<!DOCTYPE html>
<html>
<head>
  <title>Site A - Login</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
</head>
<body>
  <h1>üîê Site A - Login</h1>
  <button id="loginButton">Entrar anonimamente</button>
  <button id="logoutButton" style="display:none;">Sair</button>
  <p id="status">Status: Carregando...</p>
  <div id="logs" style="margin-top: 20px; padding: 10px; background: #f0f0f0; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto;"></div>

  <script>
    const logDiv = document.getElementById('logs');
    
    function addLog(message) {
      const timestamp = new Date().toLocaleTimeString();
      const logMessage = `[${timestamp}] ${message}`;
      console.log(logMessage);
      logDiv.innerHTML += logMessage + '<br>';
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    addLog("[Site A] üöÄ Iniciando Site A...");

    let auth;
    let isReady = false;
    let currentUser = null;
    let authInitialized = false;

    // Detecta se est√° em iframe
    const isInIframe = window !== window.parent;
    addLog(`[Site A] üì± Est√° em iframe: ${isInIframe}`);

    fetch('https://broken-silence-aaa9.workers.dev')
      .then(response => {
        addLog("[Site A] üì° Resposta da API recebida");
        return response.json();
      })
      .then(firebaseConfig => {
        addLog("[Site A] ‚öôÔ∏è Configura√ß√£o Firebase recebida");
        addLog(`[Site A] üîë Project ID: ${firebaseConfig.projectId}`);
        
        firebase.initializeApp(firebaseConfig);
        auth = firebase.auth();
        addLog("[Site A] üî• Firebase inicializado");

        // MUDAN√áA CR√çTICA: Usar persist√™ncia LOCAL sempre, mas for√ßar sincroniza√ß√£o
        return firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL);
      })
      .then(() => {
        addLog("[Site A] üíæ Persist√™ncia LOCAL configurada");
        
        // NOVA ESTRAT√âGIA: Aguardar um pouco antes de configurar o listener
        // para dar tempo ao Firebase sincronizar o estado existente
        setTimeout(() => {
          setupAuthListener();
          forceAuthStateSync();
        }, 500);
        
        // Registra listener de mensagens
        setupMessageListener();
      })
      .catch(error => {
        addLog(`[Site A] ‚ùå Erro na inicializa√ß√£o: ${error.message}`);
        console.error("[Site A] Erro completo:", error);
      });

    function setupAuthListener() {
      addLog("[Site A] üîß Configurando listener de auth...");
      
      // Configura listener de mudan√ßa de estado
      auth.onAuthStateChanged((user) => {
        addLog(`[Site A] üë§ Estado de auth mudou: ${user ? 'LOGADO' : 'DESLOGADO'}`);
        
        if (user) {
          addLog(`[Site A] üÜî UID: ${user.uid}`);
          addLog(`[Site A] üîç √â an√¥nimo: ${user.isAnonymous}`);
        }
        
        currentUser = user;
        updateStatus(user);
        
        if (!authInitialized) {
          authInitialized = true;
          addLog("[Site A] ‚úÖ Auth inicializado pela primeira vez");
        }
        
        if (!isReady) {
          isReady = true;
          addLog("[Site A] ‚úÖ Firebase est√° pronto para comunica√ß√£o");
          
          // Notifica Site B se estiver em iframe
          if (isInIframe) {
            setTimeout(() => {
              notifySiteB();
            }, 100);
          }
        } else if (isInIframe) {
          // Se j√° estava pronto, notifica mudan√ßas de estado
          setTimeout(() => {
            notifySiteB();
          }, 100);
        }
      });
    }

    function forceAuthStateSync() {
      addLog("[Site A] üîÑ For√ßando sincroniza√ß√£o do estado de auth...");
      
      if (!auth) {
        addLog("[Site A] ‚ùå Auth n√£o dispon√≠vel para sincroniza√ß√£o");
        return;
      }
      
      // ESTRAT√âGIA 1: Verificar se h√° token persistido
      const user = auth.currentUser;
      if (user) {
        addLog(`[Site A] üîë Usu√°rio j√° detectado: ${user.uid}`);
        
        // For√ßa refresh do token para garantir validade
        user.getIdToken(true)
          .then((token) => {
            addLog("[Site A] ‚úÖ Token recarregado com sucesso");
            addLog(`[Site A] üé´ Token length: ${token.length} chars`);
          })
          .catch((error) => {
            addLog(`[Site A] ‚ùå Erro ao recarregar token: ${error.message}`);
          });
      } else {
        addLog("[Site A] üîç Nenhum usu√°rio detectado inicialmente");
        
        // ESTRAT√âGIA 2: Tentar detectar sess√£o persistida manualmente
        // Isso for√ßa o Firebase a verificar se h√° uma sess√£o ativa
        auth.onIdTokenChanged((user) => {
          if (user && !currentUser) {
            addLog(`[Site A] üéâ Usu√°rio detectado via token change: ${user.uid}`);
          }
        });
        
        // ESTRAT√âGIA 3: Verificar redirect result
        auth.getRedirectResult()
          .then((result) => {
            if (result.user) {
              addLog(`[Site A] üéâ Usu√°rio recuperado do redirect: ${result.user.uid}`);
            } else {
              addLog("[Site A] üì≠ Nenhum usu√°rio no redirect result");
            }
          })
          .catch((error) => {
            addLog(`[Site A] ‚ö†Ô∏è Erro no redirect result: ${error.message}`);
          });
      }
      
      // ESTRAT√âGIA 4: Se estiver em iframe, tentar sincronizar com contexto pai
      if (isInIframe) {
        addLog("[Site A] üîó Tentando sincronizar com contexto pai...");
        
        // For√ßa uma nova verifica√ß√£o de auth ap√≥s um delay
        setTimeout(() => {
          const currentUserAfterDelay = auth.currentUser;
          if (currentUserAfterDelay && !currentUser) {
            addLog(`[Site A] üîÑ Usu√°rio detectado ap√≥s delay: ${currentUserAfterDelay.uid}`);
            currentUser = currentUserAfterDelay;
            updateStatus(currentUserAfterDelay);
          }
        }, 2000);
      }
    }

    function notifySiteB() {
      addLog("[Site A] üì§ Enviando siteAReady para Site B");
      try {
        const message = { 
          type: 'siteAReady',
          timestamp: new Date().toISOString(),
          currentUser: currentUser ? { 
            uid: currentUser.uid, 
            isAnonymous: currentUser.isAnonymous,
            authTime: currentUser.metadata?.lastSignInTime || null
          } : null,
          context: isInIframe ? 'iframe' : 'standalone'
        };
        
        addLog(`[Site A] üìã Dados enviados: ${JSON.stringify(message)}`);
        
        window.parent.postMessage(message, '*');
        addLog("[Site A] ‚úÖ Mensagem siteAReady enviada com sucesso");
      } catch (error) {
        addLog(`[Site A] ‚ùå Erro ao enviar siteAReady: ${error.message}`);
      }
    }

    function setupMessageListener() {
      addLog("[Site A] üîó Configurando listener de mensagens");
      
      window.addEventListener("message", (event) => {
        addLog(`[Site A] üì® Mensagem recebida de: ${event.origin}`);
        addLog(`[Site A] üìÑ Dados da mensagem: ${JSON.stringify(event.data)}`);

        if (!auth) {
          addLog("[Site A] ‚ö†Ô∏è Auth n√£o dispon√≠vel, ignorando mensagem");
          return;
        }

        if (event.data && event.data.type === "checkLogin") {
          addLog("[Site A] üîç Solicita√ß√£o de verifica√ß√£o de login recebida");
          
          // MUDAN√áA CR√çTICA: Fazer uma sincroniza√ß√£o mais agressiva
          performDeepAuthSync()
            .then(() => {
              const user = auth.currentUser;
              addLog(`[Site A] üë§ Usu√°rio atual ap√≥s deep sync: ${user ? user.uid : 'null'}`);
              
              const response = {
                type: "loginStatus",
                loggedIn: !!user,
                uid: user?.uid || null,
                isAnonymous: user?.isAnonymous || false,
                timestamp: new Date().toISOString(),
                context: isInIframe ? 'iframe' : 'standalone',
                syncMethod: 'deep'
              };
              
              addLog(`[Site A] üì§ Enviando resposta: ${JSON.stringify(response)}`);
              
              try {
                event.source.postMessage(response, event.origin);
                addLog("[Site A] ‚úÖ Resposta enviada com sucesso");
              } catch (error) {
                addLog(`[Site A] ‚ùå Erro ao enviar resposta: ${error.message}`);
              }
            })
            .catch((error) => {
              addLog(`[Site A] ‚ùå Erro na sincroniza√ß√£o profunda: ${error.message}`);
            });
        } else {
          addLog(`[Site A] ‚ùì Tipo de mensagem desconhecido: ${event.data?.type}`);
        }
      });
      
      addLog("[Site A] ‚úÖ Listener de mensagens configurado");
    }

    // NOVA FUN√á√ÉO: Sincroniza√ß√£o profunda e agressiva
    async function performDeepAuthSync() {
      addLog("[Site A] üî¨ Iniciando sincroniza√ß√£o profunda...");
      
      try {
        // Passo 1: Verificar usu√°rio atual
        let user = auth.currentUser;
        addLog(`[Site A] üë§ Usu√°rio atual: ${user ? user.uid : 'null'}`);
        
        // Passo 2: Se n√£o h√° usu√°rio, for√ßar reload do estado
        if (!user) {
          addLog("[Site A] üîÑ For√ßando reload do estado de auth...");
          
          // Tenta diferentes estrat√©gias de sincroniza√ß√£o
          await Promise.race([
            // Estrat√©gia 1: Aguardar mudan√ßa de estado
            new Promise((resolve) => {
              const unsubscribe = auth.onAuthStateChanged((newUser) => {
                if (newUser) {
                  addLog(`[Site A] ‚úÖ Usu√°rio detectado via state change: ${newUser.uid}`);
                  unsubscribe();
                  resolve(newUser);
                } else {
                  setTimeout(() => {
                    unsubscribe();
                    resolve(null);
                  }, 1000);
                }
              });
            }),
            
            // Estrat√©gia 2: Aguardar mudan√ßa de token
            new Promise((resolve) => {
              const unsubscribe = auth.onIdTokenChanged((newUser) => {
                if (newUser) {
                  addLog(`[Site A] ‚úÖ Usu√°rio detectado via token change: ${newUser.uid}`);
                  unsubscribe();
                  resolve(newUser);
                } else {
                  setTimeout(() => {
                    unsubscribe();
                    resolve(null);
                  }, 1000);
                }
              });
            }),
            
            // Timeout de seguran√ßa
            new Promise((resolve) => {
              setTimeout(() => {
                addLog("[Site A] ‚è∞ Timeout na sincroniza√ß√£o profunda");
                resolve(null);
              }, 3000);
            })
          ]);
          
          // Atualizar refer√™ncia do usu√°rio
          user = auth.currentUser;
        }
        
        // Passo 3: Se h√° usu√°rio, verificar se o token √© v√°lido
        if (user) {
          addLog(`[Site A] üîë Verificando validade do token para ${user.uid}...`);
          try {
            const token = await user.getIdToken(true);
            addLog(`[Site A] ‚úÖ Token v√°lido obtido (${token.length} chars)`);
            currentUser = user;
            updateStatus(user);
          } catch (tokenError) {
            addLog(`[Site A] ‚ùå Erro ao obter token: ${tokenError.message}`);
          }
        }
        
        addLog("[Site A] üèÅ Sincroniza√ß√£o profunda conclu√≠da");
        return user;
        
      } catch (error) {
        addLog(`[Site A] üí• Erro na sincroniza√ß√£o profunda: ${error.message}`);
        throw error;
      }
    }

    // Adiciona bot√£o para for√ßar sincroniza√ß√£o manual
    const syncButton = document.createElement('button');
    syncButton.id = 'syncButton';
    syncButton.textContent = 'üîÑ Sincronizar Estado';
    syncButton.style.marginLeft = '10px';
    document.querySelector('h1').after(syncButton);

    syncButton.addEventListener('click', () => {
      addLog("[Site A] üîÑ Sincroniza√ß√£o manual solicitada");
      performDeepAuthSync()
        .then((user) => {
          if (user) {
            addLog(`[Site A] ‚úÖ Ap√≥s sincroniza√ß√£o manual - Usu√°rio: ${user.uid}`);
          } else {
            addLog("[Site A] ‚ùå Ap√≥s sincroniza√ß√£o manual - Nenhum usu√°rio");
          }
        })
        .catch((error) => {
          addLog(`[Site A] ‚ùå Erro na sincroniza√ß√£o manual: ${error.message}`);
        });
    });

    // Event listeners dos bot√µes
    document.getElementById("loginButton").addEventListener("click", () => {
      addLog("[Site A] üîê Tentando fazer login an√¥nimo");
      
      if (!auth) {
        addLog("[Site A] ‚ùå Firebase ainda n√£o carregou");
        alert("Firebase ainda n√£o carregou!");
        return;
      }
      
      auth.signInAnonymously()
        .then((userCredential) => {
          const user = userCredential.user;
          addLog(`[Site A] ‚úÖ Login an√¥nimo realizado com sucesso - UID: ${user.uid}`);
          currentUser = user;
          
          // Notifica Site B imediatamente ap√≥s login (se em iframe)
          if (isInIframe) {
            setTimeout(() => {
              addLog("[Site A] üì¢ Notificando Site B sobre novo login");
              notifySiteB();
            }, 100);
          }
        })
        .catch(error => {
          addLog(`[Site A] ‚ùå Erro no login: ${error.message}`);
          console.error("[Site A] Erro completo no login:", error);
        });
    });

    document.getElementById("logoutButton").addEventListener("click", () => {
      addLog("[Site A] üö™ Fazendo logout");
      
      auth.signOut()
        .then(() => {
          addLog("[Site A] ‚úÖ Logout realizado com sucesso");
          currentUser = null;
          
          // Notifica Site B sobre logout (se em iframe)
          if (isInIframe) {
            setTimeout(() => {
              addLog("[Site A] üì¢ Notificando Site B sobre logout");
              notifySiteB();
            }, 100);
          }
        })
        .catch(error => {
          addLog(`[Site A] ‚ùå Erro no logout: ${error.message}`);
        });
    });

    function updateStatus(user) {
      const statusEl = document.getElementById("status");
      const loginBtn = document.getElementById("loginButton");
      const logoutBtn = document.getElementById("logoutButton");
      
      if (user) {
        addLog(`[Site A] üë§ Usu√°rio logado - UID: ${user.uid} | An√¥nimo: ${user.isAnonymous}`);
        statusEl.innerText = `Status: Logado! (${user.uid.substring(0, 8)}...)`;
        statusEl.style.color = "green";
        loginBtn.style.display = "none";
        logoutBtn.style.display = "inline-block";
      } else {
        addLog("[Site A] üö´ Nenhum usu√°rio logado");
        statusEl.innerText = "Status: N√£o logado";
        statusEl.style.color = "red";
        loginBtn.style.display = "inline-block";
        logoutBtn.style.display = "none";
      }
    }

    // Log quando a p√°gina termina de carregar
    window.addEventListener('load', () => {
      addLog("[Site A] üìÑ P√°gina totalmente carregada");
    });

    // Log de erros gerais
    window.addEventListener('error', (event) => {
      addLog(`[Site A] üí• Erro JavaScript: ${event.message} em ${event.filename}:${event.lineno}`);
    });

    // NOVO: Verifica√ß√£o peri√≥dica se estiver em iframe
    if (isInIframe) {
      addLog("[Site A] ‚è∞ Configurando verifica√ß√£o peri√≥dica (iframe mode)");
      
      setInterval(() => {
        const user = auth && auth.currentUser;
        if (user && (!currentUser || currentUser.uid !== user.uid)) {
          addLog(`[Site A] üîÑ Sincroniza√ß√£o peri√≥dica detectou mudan√ßa: ${user.uid}`);
          currentUser = user;
          updateStatus(user);
          notifySiteB();
        }
      }, 2000); // Verifica a cada 2 segundos
    }
  </script>
</body>
</html>
